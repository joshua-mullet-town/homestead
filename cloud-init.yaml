#cloud-config
# Homestead Droplet Provisioning Script
# Installs: Node.js, git, PM2, Claude Code, homestead terminal server
# Auto-clones selected repo and starts Claude Code session

packages:
  - curl
  - git
  - build-essential

runcmd:
  # Install Node.js v20
  - curl -fsSL https://deb.nodesource.com/setup_20.x | bash
  - apt-get install -y nodejs
  - npm install -g npm@latest

  # Install PM2 and Claude Code
  - npm install -g pm2
  - npm install -g @anthropic-ai/claude-code

  # Clone homestead terminal server
  - git clone https://github.com/joshua-mullet-town/homestead.git /root/homestead
  - cd /root/homestead && npm install
  - cd /root/homestead && npm rebuild node-pty

  # Clone user's selected repo with auth token (replaced by API at provision time)
  - git clone https://{{GITHUB_PAT}}@github.com/{{REPO_PATH}} /root/project
  - cd /root/project && git checkout -b {{BRANCH_NAME}}
  - cd /root/project && npm install

  # Set environment variables
  - echo 'export ANTHROPIC_API_KEY="{{ANTHROPIC_API_KEY}}"' >> /root/.bashrc
  - echo 'export GH_TOKEN="{{GITHUB_PAT}}"' >> /root/.bashrc
  - export ANTHROPIC_API_KEY="{{ANTHROPIC_API_KEY}}"
  - export GH_TOKEN="{{GITHUB_PAT}}"

  # Detect if project is Next.js and create PM2 ecosystem file
  - |
    if grep -q '"next"' /root/project/package.json 2>/dev/null; then
      echo "Detected Next.js project, will start dev server"
      HAS_NEXTJS=true
    else
      echo "Not a Next.js project, skipping dev server"
      HAS_NEXTJS=false
    fi

  # Create PM2 ecosystem file for terminal server (and optionally dev server)
  - |
    cat > /root/homestead/ecosystem.config.js << 'EOFPM2'
    module.exports = {
      apps: [
        {
          name: "homestead",
          script: "./server.js",
          cwd: "/root/homestead",
          instances: 1,
          autorestart: true,
          watch: false,
          env: {
            NODE_ENV: "development",
            GH_TOKEN: "{{GITHUB_PAT}}",
            ANTHROPIC_API_KEY: "{{ANTHROPIC_API_KEY}}"
          }
        }
      ]
    };
    EOFPM2

  # Add dev server to PM2 config if Next.js detected
  - |
    if grep -q '"next"' /root/project/package.json 2>/dev/null; then
      cat >> /root/homestead/ecosystem.config.js << 'EOFDEV'

    // Add Next.js dev server
    module.exports.apps.push({
      name: "dev-server",
      script: "npm",
      args: "run dev",
      cwd: "/root/project",
      instances: 1,
      autorestart: true,
      watch: false,
      env: {
        NODE_ENV: "development",
        PORT: "3000"
      }
    });
    EOFDEV
    fi

  # Start all PM2 apps
  - cd /root/homestead && pm2 start ecosystem.config.js
  - pm2 startup systemd -u root --hp /root
  - pm2 save

  # Signal completion
  - echo "Homestead provisioning complete" > /root/READY

# This takes approximately 2-3 minutes to complete
